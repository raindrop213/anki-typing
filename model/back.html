<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
</head>
<body>
    <div class="card">
        <div class="word">{{Word}}</div>
        
        <div class="typing-container" id="typingContainer">
            <div class="target-display" id="targetDisplay"></div>
            
            <div class="input-container">
                <input type="text" class="typing-input" id="typingInput" autocomplete="off" spellcheck="false">
            </div>
            
            <div class="stats">
                错误次数: <span class="error-count" id="errorCount">0</span>
            </div>
        </div>
            <div id="difficultyResult" class="difficulty-result"></div>
            <div class="instructions" id="meaningSection" style="display: none;">{{Meaning}}</div>
            <div class="instructions" id="continueSection" style="display: none;">按【Ctrl】继续</div>
        </div>
    </div>

    <script>
        // 全局变量，用于跟踪是否已初始化
        window.ankiTypingInitialized = window.ankiTypingInitialized || false;
        
        // 清理之前的事件监听器
        function cleanupEventListeners() {
            const oldInput = document.getElementById('typingInput');
            if (oldInput && oldInput.ankiInputListener) {
                oldInput.removeEventListener('input', oldInput.ankiInputListener);
            }
            
            if (window.ankiKeydownListener) {
                document.removeEventListener('keydown', window.ankiKeydownListener);
            }

            if (window.ankiSpaceListener) {
                document.removeEventListener('keydown', window.ankiSpaceListener);
                window.ankiSpaceListener = null;
            }
        }
        
        // 初始化打字练习
        function initializeTypingPractice() {
            // 清理之前的监听器
            cleanupEventListeners();
            
            // 获取目标罗马音 - 这里需要替换为实际的Anki字段
            const targetRomaji = "{{Romaji}}".toLowerCase();
            const wordDisplay = "{{Word}}"; 
            
            // 验证罗马音是否存在
            if (!targetRomaji || targetRomaji.trim() === '') {
                console.error('目标罗马音为空');
                return;
            }
            
            let currentIndex = 0;
            let errorCount = 0;
            let isComplete = false;
            
            const typingInput = document.getElementById('typingInput');
            const targetDisplay = document.getElementById('targetDisplay');
            const errorCountDisplay = document.getElementById('errorCount');
            const completeSection = document.getElementById('completeSection');
            const typingContainer = document.getElementById('typingContainer');
            const difficultyResult = document.getElementById('difficultyResult');
            
            // 重置所有状态
            function resetState() {
                currentIndex = 0;
                errorCount = 0;
                isComplete = false;
                if (typingInput) {
                    typingInput.value = '';
                    typingInput.className = 'typing-input';
                }
                if (errorCountDisplay) {
                    errorCountDisplay.textContent = '0';
                }
                if (completeSection) {
                    completeSection.classList.remove('show');
                }
                if (typingContainer) {
                    typingContainer.classList.remove('hide');
                }
            }
            
            // 更新目标显示
            function updateTargetDisplay() {
                if (!targetDisplay) return;
                
                let display = '';
                for (let i = 0; i < targetRomaji.length; i++) {
                    const char = targetRomaji[i];
                    if (i < currentIndex) {
                        display += `<span class="correct-char">${char}</span>`;
                    } else if (i === currentIndex) {
                        display += `<span class="current-char">_</span>`;
                    } else {
                        display += `<span class="remaining-char">_</span>`;
                    }
                }
                targetDisplay.innerHTML = display;
            }
            
            // 完成打字
            function completeTyping() {
                isComplete = true;
                if (typingContainer) typingContainer.classList.add('hide');
                if (completeSection) completeSection.classList.add('show');

                let difficulty, difficultyClass, difficultyText;

                if (errorCount <= 1) {
                    difficulty = 'easy';
                    difficultyClass = 'difficulty-easy';
                    difficultyText = '简单 (Easy)';
                } else if (errorCount <= 3) {
                    difficulty = 'good';
                    difficultyClass = 'difficulty-good';
                    difficultyText = '良好 (Good)';
                } else {
                    difficulty = 'hard';
                    difficultyClass = 'difficulty-hard';
                    difficultyText = '困难 (Hard)';
                }

                if (difficultyResult) {
                    difficultyResult.className = `difficulty-result ${difficultyClass}`;
                    difficultyResult.textContent = `${difficultyText} - ${errorCount} 次错误`;

                    // 绑定点击事件，点击时触发对应操作
                    difficultyResult.style.pointerEvents = 'auto'; // 确保可点
                    difficultyResult.addEventListener('click', () => {
                        if (typeof pycmd !== 'undefined') {
                            if (difficulty === 'easy') {
                                pycmd('ease4');
                            } else if (difficulty === 'good') {
                                pycmd('ease3');
                            } else {
                                pycmd('ease2');
                            }
                        }
                    });
                }

                // 显示 Meaning
                const meaningSection = document.getElementById('meaningSection');
                if (meaningSection) {
                    meaningSection.style.display = 'block';
                }

                // 显示继续提示
                const continueSection = document.getElementById('continueSection');
                continueSection.style.display = 'block';

                // 设置后续监听，按键自动 ease
                window.ankiSpaceListener = function(e) {
                    if (e.key === 'Control') {
                        if (typeof pycmd !== 'undefined') {
                            if (difficulty === 'easy') {
                                pycmd('ease4');
                            } else if (difficulty === 'good') {
                                pycmd('ease3');
                            } else {
                                pycmd('ease2');
                            }
                        }
                    }
                };
                document.addEventListener('keydown', window.ankiSpaceListener);
            }

            // 重置练习
            function resetTyping() {
                resetState();
                updateTargetDisplay();
                if (typingInput) {
                    // 延迟聚焦以确保DOM更新完成
                    setTimeout(() => {
                        typingInput.focus();
                    }, 50);
                }
            }
            
            // 输入处理函数
            function handleInput(e) {
                if (isComplete) return;
                
                const inputValue = e.target.value.toLowerCase();
                const expectedChar = targetRomaji[currentIndex];
                
                if (inputValue === expectedChar) {
                    // 正确输入
                    currentIndex++;
                    typingInput.value = '';
                    typingInput.className = 'typing-input correct';
                    
                    updateTargetDisplay();
                    
                    // 检查是否完成
                    if (currentIndex >= targetRomaji.length) {
                        completeTyping();
                    }
                    
                    // 恢复正常样式
                    setTimeout(() => {
                        if (!isComplete && typingInput) {
                            typingInput.className = 'typing-input';
                        }
                    }, 200);
                    
                } else if (inputValue.length > 0) {
                    // 错误输入
                    errorCount++;
                    if (errorCountDisplay) {
                        errorCountDisplay.textContent = errorCount;
                    }
                    typingInput.value = '';
                    typingInput.className = 'typing-input error';
                    
                    // 恢复正常样式
                    setTimeout(() => {
                        if (!isComplete && typingInput) {
                            typingInput.className = 'typing-input';
                        }
                    }, 500);
                }
            }
            
            // 键盘事件处理函数
            function handleKeydown(e) {
                if (e.key === 'Escape') {
                    resetTyping();
                }
            }
            
            // 绑定事件监听器
            if (typingInput) {
                typingInput.ankiInputListener = handleInput;
                typingInput.addEventListener('input', handleInput);
            }
            
            window.ankiKeydownListener = handleKeydown;
            document.addEventListener('keydown', handleKeydown);
            
            // 初始化显示和聚焦
            resetState();
            updateTargetDisplay();
            
            // 延迟聚焦以确保页面完全加载
            setTimeout(() => {
                if (typingInput) {
                    typingInput.focus();
                }
            }, 100);
        }
        
        // 页面加载完成后初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeTypingPractice);
        } else {
            // 如果DOM已经加载完成，立即初始化
            setTimeout(initializeTypingPractice, 50);
        }
        
        // 标记为已初始化
        window.ankiTypingInitialized = true;
    </script>
</body>
</html>