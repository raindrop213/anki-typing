<!-- 背面 -->
  

<!-- 打字练习部分 -->
<section class="typing-practice">
<div class="typing-container" id="typingContainer">
    <div class="target-display" id="targetDisplay"></div>
    <input type="text" class="typing-input" id="typingInput" autocomplete="off" spellcheck="false">
    
    <div class="typing-stats">
    错误次数: <span class="error-count" id="errorCount">0</span>
    </div>
    <div class="error-badge" id="errorBadge">0</div>
</div>

<div class="complete" id="completeSection">
    <div class="difficulty-result" id="difficultyResult"></div>
</div>
</section>

<!--可隐藏答案部分-->
<section class="hideAnswer"></section>



<script>
  // 打字练习功能
  initializeTypingPractice()

  // 转换平假名为罗马音
  function convertHiraganaToRomaji(hiragana) {
    const hiraganaToRomaji = {
      // 基本假名
      'あ': 'a', 'い': 'i', 'う': 'u', 'え': 'e', 'お': 'o',
      'か': 'ka', 'き': 'ki', 'く': 'ku', 'け': 'ke', 'こ': 'ko',
      'が': 'ga', 'ぎ': 'gi', 'ぐ': 'gu', 'げ': 'ge', 'ご': 'go',
      'さ': 'sa', 'し': 'shi', 'す': 'su', 'せ': 'se', 'そ': 'so',
      'ざ': 'za', 'じ': 'ji', 'ず': 'zu', 'ぜ': 'ze', 'ぞ': 'zo',
      'た': 'ta', 'ち': 'chi', 'つ': 'tsu', 'て': 'te', 'と': 'to',
      'だ': 'da', 'ぢ': 'ji', 'づ': 'zu', 'で': 'de', 'ど': 'do',
      'な': 'na', 'に': 'ni', 'ぬ': 'nu', 'ね': 'ne', 'の': 'no',
      'は': 'ha', 'ひ': 'hi', 'ふ': 'fu', 'へ': 'he', 'ほ': 'ho',
      'ば': 'ba', 'び': 'bi', 'ぶ': 'bu', 'べ': 'be', 'ぼ': 'bo',
      'ぱ': 'pa', 'ぴ': 'pi', 'ぷ': 'pu', 'ぺ': 'pe', 'ぽ': 'po',
      'ま': 'ma', 'み': 'mi', 'む': 'mu', 'め': 'me', 'も': 'mo',
      'や': 'ya', 'ゆ': 'yu', 'よ': 'yo',
      'ら': 'ra', 'り': 'ri', 'る': 'ru', 'れ': 're', 'ろ': 'ro',
      'わ': 'wa', 'ゐ': 'wi', 'ゑ': 'we', 'を': 'wo', 'ん': 'n',
      
      // 拗音
      'きゃ': 'kya', 'きゅ': 'kyu', 'きょ': 'kyo',
      'ぎゃ': 'gya', 'ぎゅ': 'gyu', 'ぎょ': 'gyo',
      'しゃ': 'sha', 'しゅ': 'shu', 'しょ': 'sho',
      'じゃ': 'ja', 'じゅ': 'ju', 'じょ': 'jo',
      'ちゃ': 'cha', 'ちゅ': 'chu', 'ちょ': 'cho',
      'にゃ': 'nya', 'にゅ': 'nyu', 'にょ': 'nyo',
      'ひゃ': 'hya', 'ひゅ': 'hyu', 'ひょ': 'hyo',
      'びゃ': 'bya', 'びゅ': 'byu', 'びょ': 'byo',
      'ぴゃ': 'pya', 'ぴゅ': 'pyu', 'ぴょ': 'pyo',
      'みゃ': 'mya', 'みゅ': 'myu', 'みょ': 'myo',
      'りゃ': 'rya', 'りゅ': 'ryu', 'りょ': 'ryo',
      
      // 特殊记号
      'ー': '-', '・': '・'
    };

    if (!hiragana) return '';
    
    let result = '';
    let i = 0;
    
    while (i < hiragana.length) {
      let converted = false;
      
      // 处理促音 (っ)
      if (hiragana[i] === 'っ' && i + 1 < hiragana.length) {
        const nextChar = hiragana[i + 1];
        const nextRomaji = hiraganaToRomaji[nextChar];
        if (nextRomaji) {
          result += nextRomaji[0]; // 重复辅音
          i++;
          continue;
        }
      }
      
      // 检查拗音 (2字符)
      if (i + 1 < hiragana.length) {
        const twoChar = hiragana.slice(i, i + 2);
        if (hiraganaToRomaji[twoChar]) {
          result += hiraganaToRomaji[twoChar];
          i += 2;
          converted = true;
        }
      }
      
      // 检查单个字符
      if (!converted) {
        const oneChar = hiragana[i];
        if (hiraganaToRomaji[oneChar]) {
          // 处理特殊的 'n' 规则
          if (oneChar === 'ん') {
            // 如果后面是 y, w 或元音，使用 n'
            if (i + 1 < hiragana.length) {
              const next = hiragana[i + 1];
              if ('あいうえおやゆよわをん'.includes(next) || next === 'y' || next === 'w') {
                result += "n'";
              } else {
                result += 'n';
              }
            } else {
              result += 'n';
            }
          } else {
            result += hiraganaToRomaji[oneChar];
          }
          i++;
          converted = true;
        }
      }
      
      // 如果没有转换，保持原字符
      if (!converted) {
        result += hiragana[i];
        i++;
      }
    }
    
    // 清理多余的空格和特殊字符，但保留单个空格
    return result.replace(/\s+/g, ' ').toLowerCase();
  }

  // 初始化打字练习
  function initializeTypingPractice() {
    // 获取目标罗马音
    let targetRomaji = convertHiraganaToRomaji("{{VocabFurigana}}");
    
    // 验证罗马音是否存在
    if (!targetRomaji || targetRomaji.trim() === '') {
      console.error('目标罗马音为空');
      return;
    }
    
    // 移除末尾空格并在末尾加一个空格
    targetRomaji = targetRomaji.trim() + ' ';
    
    let currentIndex = 0;
    let errorCount = 0;
    let isComplete = false;
    let difficultyPrepared = false;
    
    const typingInput = document.getElementById('typingInput');
    const targetDisplay = document.getElementById('targetDisplay');
    const errorCountDisplay = document.getElementById('errorCount');
    const errorBadgeDisplay = document.getElementById('errorBadge');
    const completeSection = document.getElementById('completeSection');
    const typingContainer = document.getElementById('typingContainer');
    const difficultyResult = document.getElementById('difficultyResult');
    const hideableElements = document.querySelectorAll('.hideAnswer');
    
    // 更新错误计数显示
    function updateErrorCount() {
      if (errorCountDisplay) {
        errorCountDisplay.textContent = errorCount;
      }
      if (errorBadgeDisplay) {
        errorBadgeDisplay.textContent = errorCount;
      }
    }
    
    // 重置所有状态
    function resetState() {
      currentIndex = 0;
      errorCount = 0;
      isComplete = false;
      difficultyPrepared = false;
      
      // 统一隐藏可隐藏内容
      hideableElements.forEach(element => {
        element.style.display = 'none';
      });
      
      if (typingInput) {
        typingInput.value = '';
        typingInput.className = 'typing-input';
      }
      updateErrorCount();
      if (completeSection) {
        completeSection.classList.remove('show');
      }
      if (typingContainer) {
        typingContainer.classList.remove('hide');
      }
    }
    
    // 更新目标显示
    function updateTargetDisplay() {
      if (!targetDisplay) return;
      
      let display = '';
      // 不显示最后的空格，所以长度减1
      for (let i = 0; i < targetRomaji.length - 1; i++) {
        const char = targetRomaji[i];
        
        if (i < currentIndex) {
          display += `<span class="correct-char">${char}</span>`;
        } else if (i === currentIndex) {
          display += `<span class="current-char">_</span>`;
        } else {
          display += `<span class="remaining-char">_</span>`;
        }
      }
      targetDisplay.innerHTML = display;
    }
    
    // 准备难度显示
    function prepareDifficultyDisplay() {
      // 统一显示可隐藏内容
      hideableElements.forEach(element => {
        element.style.display = 'block';
      });
      
      if (completeSection) {
        completeSection.classList.add('show');
        completeSection.addEventListener('click', completeTyping);
      }

      let difficulty, difficultyClass, difficultyText;

      if (errorCount <= 1) {
        difficulty = 'easy';
        difficultyClass = 'difficulty-easy';
        difficultyText = '简单';
      } else if (errorCount <= 3) {
        difficulty = 'good';
        difficultyClass = 'difficulty-good';
        difficultyText = '良好';
      } else {
        difficulty = 'hard';
        difficultyClass = 'difficulty-hard';
        difficultyText = '困难';
      }

      if (difficultyResult) {
        difficultyResult.className = `difficulty-result ${difficultyClass}`;
        difficultyResult.textContent = `${difficultyText} - 按【空格】继续`;
      }
    }

    // 自动完成剩余字母
    function autoCompleteRemaining() {
      if (isComplete || currentIndex >= targetRomaji.length - 1) return;
      
      // 逐个输入剩余的字符，但保留最后一个字符不输入
      function inputNextChar() {
        // 只输入到倒数第二个字符，留下最后一个让用户手动输入
        if (currentIndex >= targetRomaji.length - 1 || isComplete) return;
        
        const charToInput = targetRomaji[currentIndex];
        
        // 模拟正确输入
        if (typingInput) {
          typingInput.value = charToInput;
          // 创建一个模拟的输入事件
          const event = { target: { value: charToInput } };
          handleInput(event);
        }
        
        // 如果还没到倒数第二个字符，继续输入下一个字符
        if (currentIndex < targetRomaji.length - 1 && !isComplete) {
          setTimeout(inputNextChar, 10);
        }
      }
      
      inputNextChar();
    }

    // 完成打字
    function completeTyping() {
      isComplete = true;
      if (typingContainer) typingContainer.classList.add('hide');

      let difficulty;

      if (errorCount <= 1) {
        difficulty = 'easy';
      } else if (errorCount <= 3) {
        difficulty = 'good';
      } else {
        difficulty = 'hard';
      }

      // 直接执行判断
      if (typeof pycmd !== 'undefined') {
        if (difficulty === 'easy') {
          pycmd('ease4');
        } else if (difficulty === 'good') {
          pycmd('ease3');
        } else {
          pycmd('ease2');
        }
      }
    }

    // 重置练习
    function resetTyping() {
      resetState();
      updateTargetDisplay();
      if (typingInput) {
        setTimeout(() => {
          typingInput.focus();
        }, 50);
      }
    }
    
    // 输入处理函数
    function handleInput(e) {
      if (isComplete) return;
      
      const inputValue = e.target.value.toLowerCase();
      const expectedChar = targetRomaji[currentIndex];
      
      if (inputValue === expectedChar) {
        // 正确输入
        currentIndex++;
        typingInput.value = '';
        typingInput.className = 'typing-input correct';
        
        updateTargetDisplay();
        
        // 检查是否到达倒数第二个字符（准备难度显示）
        if (currentIndex === targetRomaji.length - 1 && !difficultyPrepared) {
          difficultyPrepared = true;
          prepareDifficultyDisplay();
        }
        
        // 检查是否完成（输入了最后的空格）
        if (currentIndex >= targetRomaji.length) {
          completeTyping();
        }
        
        // 恢复正常样式
        setTimeout(() => {
          if (!isComplete && typingInput) {
            typingInput.className = 'typing-input';
          }
        }, 200);
        
      } else if (inputValue.length > 0) {
        // 错误输入
        errorCount++;
        updateErrorCount();
        typingInput.value = '';
        typingInput.className = 'typing-input error';
        
        // 恢复正常样式
        setTimeout(() => {
          if (!isComplete && typingInput) {
            typingInput.className = 'typing-input';
          }
        }, 500);
      }
    }
    
    // 键盘事件处理函数
    function handleKeydown(e) {
      if (e.key === 'Control') {
        e.preventDefault(); // 防止浏览器默认行为
        
        if (isComplete) {
          // 输入完成后，朗读单词
          const vocabAudio = document.querySelector('.VocabAudio');
          if (vocabAudio) {
            const audioElement = vocabAudio.querySelector('audio');
            if (audioElement) {
              audioElement.play();
            }
          }
        } else {
          // 输入未完成，增加3次错误
          errorCount += 3;
          updateErrorCount();
          
          // 显示错误提示
          if (typingInput) {
            typingInput.className = 'typing-input error';
            setTimeout(() => {
              if (!isComplete && typingInput) {
                typingInput.className = 'typing-input';
              }
            }, 500);
          }
        }
      } else if (e.key === 'Escape') {
        e.preventDefault(); // 防止浏览器默认行为
        
        if (!isComplete) {
          errorCount += 4;
          updateErrorCount();
          // 按 ESC 键自动输入完剩下的字母
          autoCompleteRemaining();
        }
      }
    }
    
    // 绑定事件监听器
    if (typingInput) {
      typingInput.addEventListener('input', handleInput);
    }
    
    document.addEventListener('keydown', handleKeydown);
    
    // 初始化显示和聚焦
    resetState();
    updateTargetDisplay();
    
    // 延迟聚焦以确保页面完全加载
    setTimeout(() => {
      if (typingInput) {
        typingInput.focus();
      }
    }, 100);
  }
</script>
