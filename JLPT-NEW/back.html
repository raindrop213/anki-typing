<!-- Card1 [日-中] 背面 -->

{{^Alt1}}

{{FrontSide}}

<div class="VocabAudio !hidden">{{VocabAudio}}</div>

<main id="BackSide" class="CardSide">
  <section class="Answer">
    <h2 class="VocabFurigana">
      <span lang="ja">{{kana:VocabFurigana}}</span>
      <span class="VocabPitch">{{VocabPitch}}</span>
    </h2>

    <h3 class="VocabPoS LabelIndent2">
      <span class="VocabDef">{{VocabDefCN}}</span>
    </h3>

    {{#VocabPlus}}
    <h3 class="VocabPlus LabelIndent" lang="ja">
      {{furigana:VocabPlus}}
    </h3>
    {{/VocabPlus}}
  </section>

  <!-- 打字练习部分 -->
  <section class="typing-practice">
    <div class="typing-container" id="typingContainer">
      <div class="target-display" id="targetDisplay"></div>
      <input type="text" class="typing-input" id="typingInput" autocomplete="off" spellcheck="false">
      
      <div class="typing-stats">
        错误次数: <span class="error-count" id="errorCount">0</span>
      </div>
      
      <div class="typing-instructions">
        输入罗马音拼写，ESC键重置
      </div>
    </div>

    <div class="complete" id="completeSection">
      <div class="difficulty-result" id="difficultyResult"></div>
    </div>
  </section>

  <ul class="SentenceList">
    {{#SentKanji1}}
    <li class="Sentence">
      <div class="SentGroup">
        <h3 class="SentFurigana LabelIndent" lang="ja">
          {{#SentFurigana1}}{{furigana:SentFurigana1}}{{/SentFurigana1}}
          {{^SentFurigana1}}{{furigana:SentKanji1}}{{/SentFurigana1}}
        </h3>
        <h3 class="SentDef LabelIndent">{{SentDef1}}</h3>
      </div>
      <div class="SentAudio">{{SentAudio1}}</div>
    </li>
    {{/SentKanji1}}

    {{#SentKanji2}}
    <li class="Sentence">
      <div class="SentGroup">
        <h3 class="SentFurigana LabelIndent" lang="ja">
          {{#SentFurigana2}}{{furigana:SentFurigana2}}{{/SentFurigana2}}
          {{^SentFurigana2}}{{furigana:SentKanji2}}{{/SentFurigana2}}
        </h3>
        <h3 class="SentDef LabelIndent">{{SentDef2}}</h3>
      </div>
      <div class="SentAudio">{{SentAudio2}}</div>
    </li>
    {{/SentKanji2}}

    {{#SentKanji3}}
    <li class="Sentence">
      <div class="SentGroup">
        <h3 class="SentFurigana LabelIndent" lang="ja">
          {{#SentFurigana3}}{{furigana:SentFurigana3}}{{/SentFurigana3}}
          {{^SentFurigana3}}{{furigana:SentKanji3}}{{/SentFurigana3}}
        </h3>
        <h3 class="SentDef LabelIndent">{{SentDef3}}</h3>
      </div>
      <div class="SentAudio">{{SentAudio3}}</div>
    </li>
    {{/SentKanji3}}

    {{#SentKanji4}}
    <li class="Sentence">
      <div class="SentGroup">
        <h3 class="SentFurigana LabelIndent" lang="ja">
          {{#SentFurigana4}}{{furigana:SentFurigana4}}{{/SentFurigana4}}
          {{^SentFurigana4}}{{furigana:SentKanji4}}{{/SentFurigana4}}
        </h3>
        <h3 class="SentDef LabelIndent">{{SentDef4}}</h3>
      </div>
      <div class="SentAudio">{{SentAudio4}}</div>
    </li>
    {{/SentKanji4}}

  </ul>
</main>

<script>
  showHint()
  setEdgeTTS()
  autoCopyWord()
  highlightWords()
  audioStylePatch()
  hideFrontElements()
  typeof onShownHook !== 'undefined' ? onShownHook.push(forcePlayback) : forcePlayback()

  // 安卓平台需要重复正面调用的方法
  if (isAndroid()) setupCard()

  // 打字练习功能
  initializeTypingPractice()

  // 转换平假名为罗马音
  function convertHiraganaToRomaji(hiragana) {
    const hiraganaToRomaji = {
      // 基本假名
      'あ': 'a', 'い': 'i', 'う': 'u', 'え': 'e', 'お': 'o',
      'か': 'ka', 'き': 'ki', 'く': 'ku', 'け': 'ke', 'こ': 'ko',
      'が': 'ga', 'ぎ': 'gi', 'ぐ': 'gu', 'げ': 'ge', 'ご': 'go',
      'さ': 'sa', 'し': 'shi', 'す': 'su', 'せ': 'se', 'そ': 'so',
      'ざ': 'za', 'じ': 'ji', 'ず': 'zu', 'ぜ': 'ze', 'ぞ': 'zo',
      'た': 'ta', 'ち': 'chi', 'つ': 'tsu', 'て': 'te', 'と': 'to',
      'だ': 'da', 'ぢ': 'ji', 'づ': 'zu', 'で': 'de', 'ど': 'do',
      'な': 'na', 'に': 'ni', 'ぬ': 'nu', 'ね': 'ne', 'の': 'no',
      'は': 'ha', 'ひ': 'hi', 'ふ': 'fu', 'へ': 'he', 'ほ': 'ho',
      'ば': 'ba', 'び': 'bi', 'ぶ': 'bu', 'べ': 'be', 'ぼ': 'bo',
      'ぱ': 'pa', 'ぴ': 'pi', 'ぷ': 'pu', 'ぺ': 'pe', 'ぽ': 'po',
      'ま': 'ma', 'み': 'mi', 'む': 'mu', 'め': 'me', 'も': 'mo',
      'や': 'ya', 'ゆ': 'yu', 'よ': 'yo',
      'ら': 'ra', 'り': 'ri', 'る': 'ru', 'れ': 're', 'ろ': 'ro',
      'わ': 'wa', 'ゐ': 'wi', 'ゑ': 'we', 'を': 'wo', 'ん': 'n',
      
      // 拗音
      'きゃ': 'kya', 'きゅ': 'kyu', 'きょ': 'kyo',
      'ぎゃ': 'gya', 'ぎゅ': 'gyu', 'ぎょ': 'gyo',
      'しゃ': 'sha', 'しゅ': 'shu', 'しょ': 'sho',
      'じゃ': 'ja', 'じゅ': 'ju', 'じょ': 'jo',
      'ちゃ': 'cha', 'ちゅ': 'chu', 'ちょ': 'cho',
      'にゃ': 'nya', 'にゅ': 'nyu', 'にょ': 'nyo',
      'ひゃ': 'hya', 'ひゅ': 'hyu', 'ひょ': 'hyo',
      'びゃ': 'bya', 'びゅ': 'byu', 'びょ': 'byo',
      'ぴゃ': 'pya', 'ぴゅ': 'pyu', 'ぴょ': 'pyo',
      'みゃ': 'mya', 'みゅ': 'myu', 'みょ': 'myo',
      'りゃ': 'rya', 'りゅ': 'ryu', 'りょ': 'ryo',
      
      // 特殊记号
      'ー': '-', '・': '・'
    };

    if (!hiragana) return '';
    
    let result = '';
    let i = 0;
    
    while (i < hiragana.length) {
      let converted = false;
      
      // 处理促音 (っ)
      if (hiragana[i] === 'っ' && i + 1 < hiragana.length) {
        const nextChar = hiragana[i + 1];
        const nextRomaji = hiraganaToRomaji[nextChar];
        if (nextRomaji) {
          result += nextRomaji[0]; // 重复辅音
          i++;
          continue;
        }
      }
      
      // 检查拗音 (2字符)
      if (i + 1 < hiragana.length) {
        const twoChar = hiragana.slice(i, i + 2);
        if (hiraganaToRomaji[twoChar]) {
          result += hiraganaToRomaji[twoChar];
          i += 2;
          converted = true;
        }
      }
      
      // 检查单个字符
      if (!converted) {
        const oneChar = hiragana[i];
        if (hiraganaToRomaji[oneChar]) {
          // 处理特殊的 'n' 规则
          if (oneChar === 'ん') {
            // 如果后面是 y, w 或元音，使用 n'
            if (i + 1 < hiragana.length) {
              const next = hiragana[i + 1];
              if ('あいうえおやゆよわをん'.includes(next) || next === 'y' || next === 'w') {
                result += "n'";
              } else {
                result += 'n';
              }
            } else {
              result += 'n';
            }
          } else {
            result += hiraganaToRomaji[oneChar];
          }
          i++;
          converted = true;
        }
      }
      
      // 如果没有转换，保持原字符
      if (!converted) {
        result += hiragana[i];
        i++;
      }
    }
    
    // 清理多余的空格和特殊字符，但保留单个空格
    return result.replace(/\s+/g, ' ').toLowerCase();
  }

  // 初始化打字练习
  function initializeTypingPractice() {
    // 获取目标罗马音
    let targetRomaji = convertHiraganaToRomaji("{{VocabFurigana}}");
    
    // 验证罗马音是否存在
    if (!targetRomaji || targetRomaji.trim() === '') {
      console.error('目标罗马音为空');
      return;
    }
    
    // 移除末尾空格
    targetRomaji = targetRomaji.trim();
    
    let currentIndex = 0;
    let errorCount = 0;
    let isComplete = false;
    
    const typingInput = document.getElementById('typingInput');
    const targetDisplay = document.getElementById('targetDisplay');
    const errorCountDisplay = document.getElementById('errorCount');
    const completeSection = document.getElementById('completeSection');
    const typingContainer = document.getElementById('typingContainer');
    const difficultyResult = document.getElementById('difficultyResult');
    
    // 重置所有状态
    function resetState() {
      currentIndex = 0;
      errorCount = 0;
      isComplete = false;
      if (typingInput) {
        typingInput.value = '';
        typingInput.className = 'typing-input';
      }
      if (errorCountDisplay) {
        errorCountDisplay.textContent = '0';
      }
      if (completeSection) {
        completeSection.classList.remove('show');
      }
      if (typingContainer) {
        typingContainer.classList.remove('hide');
      }
    }
    
    // 更新目标显示
    function updateTargetDisplay() {
      if (!targetDisplay) return;
      
      let display = '';
      for (let i = 0; i < targetRomaji.length; i++) {
        const char = targetRomaji[i];
        if (i < currentIndex) {
          display += `<span class="correct-char">${char}</span>`;
        } else if (i === currentIndex) {
          display += `<span class="current-char">${char}</span>`;
        } else {
          display += `<span class="remaining-char">${char}</span>`;
        }
      }
      targetDisplay.innerHTML = display;
    }
    
    // 完成打字
    function completeTyping() {
      isComplete = true;
      if (typingContainer) typingContainer.classList.add('hide');
      if (completeSection) completeSection.classList.add('show');

      let difficulty, difficultyClass, difficultyText;

      if (errorCount <= 1) {
        difficulty = 'easy';
        difficultyClass = 'difficulty-easy';
        difficultyText = '简单';
      } else if (errorCount <= 3) {
        difficulty = 'good';
        difficultyClass = 'difficulty-good';
        difficultyText = '良好';
      } else {
        difficulty = 'hard';
        difficultyClass = 'difficulty-hard';
        difficultyText = '困难';
      }

      if (difficultyResult) {
        difficultyResult.className = `difficulty-result ${difficultyClass}`;
        difficultyResult.textContent = `${difficultyText} - ${errorCount} 次错误 - 按【Ctrl】继续`;

        // 统一的动作处理函数
        const handleAction = () => {
          if (typeof pycmd !== 'undefined') {
            if (difficulty === 'easy') {
              pycmd('ease4');
            } else if (difficulty === 'good') {
              pycmd('ease3');
            } else {
              pycmd('ease2');
            }
          }
        };

        // 绑定点击事件
        difficultyResult.onclick = handleAction;
        
        // 绑定键盘事件到结果元素本身
        difficultyResult.onkeydown = (e) => {
          if (e.ctrlKey) {
            e.preventDefault();
            handleAction();
          }
        };
        
        // 确保元素可以接收键盘焦点
        difficultyResult.tabIndex = 0;
        difficultyResult.focus();
      }
    }

    // 重置练习
    function resetTyping() {
      resetState();
      updateTargetDisplay();
      if (typingInput) {
        setTimeout(() => {
          typingInput.focus();
        }, 50);
      }
    }
    
    // 输入处理函数
    function handleInput(e) {
      if (isComplete) return;
      
      const inputValue = e.target.value.toLowerCase();
      const expectedChar = targetRomaji[currentIndex];
      
      if (inputValue === expectedChar) {
        // 正确输入
        currentIndex++;
        typingInput.value = '';
        typingInput.className = 'typing-input correct';
        
        updateTargetDisplay();
        
        // 检查是否完成
        if (currentIndex >= targetRomaji.length) {
          completeTyping();
        }
        
        // 恢复正常样式
        setTimeout(() => {
          if (!isComplete && typingInput) {
            typingInput.className = 'typing-input';
          }
        }, 200);
        
      } else if (inputValue.length > 0) {
        // 错误输入
        errorCount++;
        if (errorCountDisplay) {
          errorCountDisplay.textContent = errorCount;
        }
        typingInput.value = '';
        typingInput.className = 'typing-input error';
        
        // 恢复正常样式
        setTimeout(() => {
          if (!isComplete && typingInput) {
            typingInput.className = 'typing-input';
          }
        }, 500);
      }
    }
    
    // 键盘事件处理函数
    function handleKeydown(e) {
      if (e.key === 'Escape') {
        resetTyping();
      }
    }
    
    // 绑定事件监听器
    if (typingInput) {
      typingInput.addEventListener('input', handleInput);
    }
    
    document.addEventListener('keydown', handleKeydown);
    
    // 初始化显示和聚焦
    resetState();
    updateTargetDisplay();
    
    // 延迟聚焦以确保页面完全加载
    setTimeout(() => {
      if (typingInput) {
        typingInput.focus();
      }
    }, 100);
  }
</script>

{{/Alt1}}