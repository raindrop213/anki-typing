<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        .card {
            font-family: 'Hiragino Kaku Gothic Pro', 'Meiryo', sans-serif;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .word {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .typing-container {
            display: block;
        }

        .target-display {
            font-size: 20px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
            opacity: 0.8;
            min-height: 30px;
        }

        .input-container {
            margin: 30px 0;
            position: relative;
        }

        .typing-input {
            font-size: 24px;
            padding: 15px 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            background: rgba(255,255,255,0.9);
            color: #333;
            text-align: center;
            min-width: 300px;
            outline: none;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
        }

        .typing-input.correct {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .typing-input.error {
            border-color: #f44336;
            background: rgba(244, 67, 54, 0.1);
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .stats {
            margin: 20px 0;
            font-size: 18px;
        }

        .error-count {
            color: #ffcccb;
            font-weight: bold;
        }

        .correct-char {
            color: #4CAF50;
            background: rgba(76, 175, 80, 0.2);
            padding: 2px 4px;
            border-radius: 3px;
        }

        .current-char {
            background: rgba(255, 255, 255, 0.3);
            padding: 2px 4px;
            border-radius: 3px;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }

        .remaining-char {
            opacity: 0.6;
        }

        .instructions {
            font-size: 14px;
            margin-top: 20px;
            opacity: 0.8;
        }

        .complete {
            display: none;
        }

        .complete.show {
            display: block;
        }

        .typing-container.hide {
            display: none;
        }

        .difficulty-result {
            font-size: 24px;
            font-weight: bold;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
        }

        .difficulty-easy {
            background: rgba(76, 175, 80, 0.3);
            border: 2px solid #4CAF50;
        }

        .difficulty-good {
            background: rgba(255, 193, 7, 0.3);
            border: 2px solid #FFC107;
        }

        .difficulty-hard {
            background: rgba(244, 67, 54, 0.3);
            border: 2px solid #f44336;
        }
    </style>
</head>
<body>
    <div class="card">
        <div class="word">{{kanji:VocabKanji}}</div>
        
        <div class="typing-container" id="typingContainer">
            <div class="target-display" id="targetDisplay"></div>
            
            <div class="input-container">
                <input type="text" class="typing-input" id="typingInput" autocomplete="off" spellcheck="false">
            </div>
            
            <div class="stats">
                错误次数: <span class="error-count" id="errorCount">0</span>
            </div>
        </div>
            <div id="difficultyResult" class="difficulty-result"></div>
            <div class="instructions" id="meaningSection" style="display: none;">
                <ul>
                    <li>
                        <div>
                            {{#SentFurigana1}}{{furigana:SentFurigana1}}{{/SentFurigana1}}
                            {{^SentFurigana1}}{{furigana:SentKanji1}}{{/SentFurigana1}}
                        </div>
                    </li>
                    <li>
                        <div>
                            {{#SentFurigana2}}{{furigana:SentFurigana2}}{{/SentFurigana2}}
                            {{^SentFurigana2}}{{furigana:SentKanji2}}{{/SentFurigana2}}
                        </div>
                    </li>
                    <li>
                        <div>
                            {{#SentFurigana3}}{{furigana:SentFurigana3}}{{/SentFurigana3}}
                            {{^SentFurigana3}}{{furigana:SentKanji3}}{{/SentFurigana3}}
                        </div>
                    </li>
                    <li>
                        <div>
                            {{#SentFurigana4}}{{furigana:SentFurigana4}}{{/SentFurigana4}}
                            {{^SentFurigana4}}{{furigana:SentKanji4}}{{/SentFurigana4}}
                        </div>
                    </li>
                </ul>

            </div>
            <div class="instructions" id="continueSection" style="display: none;">按【空格】继续</div>
        </div>
    </div>

    <script>
        // 全局变量，用于跟踪是否已初始化
        window.ankiTypingInitialized = window.ankiTypingInitialized || false;
        

        // 清理之前的事件监听器
        function cleanupEventListeners() {
            const oldInput = document.getElementById('typingInput');
            if (oldInput && oldInput.ankiInputListener) {
                oldInput.removeEventListener('input', oldInput.ankiInputListener);
            }
            
            if (window.ankiKeydownListener) {
                document.removeEventListener('keydown', window.ankiKeydownListener);
            }

            if (window.ankiSpaceListener) {
                document.removeEventListener('keydown', window.ankiSpaceListener);
                window.ankiSpaceListener = null;
            }
        }

        // 初始化打字练习
        function initializeTypingPractice() {
            // 清理之前的监听器
            cleanupEventListeners();
            
            // 获取目标罗马音 - 这里需要替换为实际的Anki字段
            const targetRomaji = convertHiraganaToRomaji("{{VocabFurigana}}");
            
            // 验证罗马音是否存在
            if (!targetRomaji || targetRomaji.trim() === '') {
                console.error('目标罗马音为空');
                return;
            }
            
            let currentIndex = 0;
            let errorCount = 0;
            let isComplete = false;
            
            const typingInput = document.getElementById('typingInput');
            const targetDisplay = document.getElementById('targetDisplay');
            const errorCountDisplay = document.getElementById('errorCount');
            const completeSection = document.getElementById('completeSection');
            const typingContainer = document.getElementById('typingContainer');
            const difficultyResult = document.getElementById('difficultyResult');
            
            // 重置所有状态
            function resetState() {
                currentIndex = 0;
                errorCount = 0;
                isComplete = false;
                if (typingInput) {
                    typingInput.value = '';
                    typingInput.className = 'typing-input';
                }
                if (errorCountDisplay) {
                    errorCountDisplay.textContent = '0';
                }
                if (completeSection) {
                    completeSection.classList.remove('show');
                }
                if (typingContainer) {
                    typingContainer.classList.remove('hide');
                }
            }
            
            // 更新目标显示
            function updateTargetDisplay() {
                if (!targetDisplay) return;
                
                let display = '';
                for (let i = 0; i < targetRomaji.length; i++) {
                    const char = targetRomaji[i];
                    if (i < currentIndex) {
                        display += `<span class="correct-char">${char}</span>`;
                    } else if (i === currentIndex) {
                        display += `<span class="current-char">_</span>`;
                    } else {
                        display += `<span class="remaining-char">_</span>`;
                    }
                }
                targetDisplay.innerHTML = display;
            }
            
            // 完成打字
            function completeTyping() {
                isComplete = true;
                if (typingContainer) typingContainer.classList.add('hide');
                if (completeSection) completeSection.classList.add('show');

                let difficulty, difficultyClass, difficultyText;

                if (errorCount <= 1) {
                    difficulty = 'easy';
                    difficultyClass = 'difficulty-easy';
                    difficultyText = '简单 (Easy)';
                } else if (errorCount <= 3) {
                    difficulty = 'good';
                    difficultyClass = 'difficulty-good';
                    difficultyText = '良好 (Good)';
                } else {
                    difficulty = 'hard';
                    difficultyClass = 'difficulty-hard';
                    difficultyText = '困难 (Hard)';
                }

                if (difficultyResult) {
                    difficultyResult.className = `difficulty-result ${difficultyClass}`;
                    difficultyResult.textContent = `${difficultyText} - ${errorCount} 次错误`;

                    // 绑定点击事件，点击时触发对应操作
                    difficultyResult.style.pointerEvents = 'auto'; // 确保可点
                    difficultyResult.addEventListener('click', () => {
                        if (typeof pycmd !== 'undefined') {
                            if (difficulty === 'easy') {
                                pycmd('ease4');
                            } else if (difficulty === 'good') {
                                pycmd('ease3');
                            } else {
                                pycmd('ease2');
                            }
                        }
                    });
                }

                // 显示 Meaning
                const meaningSection = document.getElementById('meaningSection');
                if (meaningSection) {
                    meaningSection.style.display = 'block';
                }

                // 显示继续提示
                const continueSection = document.getElementById('continueSection');
                continueSection.style.display = 'block';

                // 设置后续监听，按键自动 ease
                window.ankiSpaceListener = function(e) {
                    if (e.key === 'Control') {
                        if (typeof pycmd !== 'undefined') {
                            if (difficulty === 'easy') {
                                pycmd('ease4');
                            } else if (difficulty === 'good') {
                                pycmd('ease3');
                            } else {
                                pycmd('ease2');
                            }
                        }
                    }
                };
                document.addEventListener('keydown', window.ankiSpaceListener);
            }

            // 重置练习
            function resetTyping() {
                resetState();
                updateTargetDisplay();
                if (typingInput) {
                    // 延迟聚焦以确保DOM更新完成
                    setTimeout(() => {
                        typingInput.focus();
                    }, 50);
                }
            }
            
            // 输入处理函数
            function handleInput(e) {
                if (isComplete) return;
                
                const inputValue = e.target.value.toLowerCase();
                const expectedChar = targetRomaji[currentIndex];
                
                if (inputValue === expectedChar) {
                    // 正确输入
                    currentIndex++;
                    typingInput.value = '';
                    typingInput.className = 'typing-input correct';
                    
                    updateTargetDisplay();
                    
                    // 检查是否完成
                    if (currentIndex >= targetRomaji.length) {
                        completeTyping();
                    }
                    
                    // 恢复正常样式
                    setTimeout(() => {
                        if (!isComplete && typingInput) {
                            typingInput.className = 'typing-input';
                        }
                    }, 200);
                    
                } else if (inputValue.length > 0) {
                    // 错误输入
                    errorCount++;
                    if (errorCountDisplay) {
                        errorCountDisplay.textContent = errorCount;
                    }
                    typingInput.value = '';
                    typingInput.className = 'typing-input error';
                    
                    // 恢复正常样式
                    setTimeout(() => {
                        if (!isComplete && typingInput) {
                            typingInput.className = 'typing-input';
                        }
                    }, 500);
                }
            }
            
            // 键盘事件处理函数
            function handleKeydown(e) {
                if (e.key === 'Escape') {
                    resetTyping();
                }
            }
            
            // 绑定事件监听器
            if (typingInput) {
                typingInput.ankiInputListener = handleInput;
                typingInput.addEventListener('input', handleInput);
            }
            
            window.ankiKeydownListener = handleKeydown;
            document.addEventListener('keydown', handleKeydown);
            
            // 初始化显示和聚焦
            resetState();
            updateTargetDisplay();
            
            // 延迟聚焦以确保页面完全加载
            setTimeout(() => {
                if (typingInput) {
                    typingInput.focus();
                }
            }, 100);
        }
        
        // 页面加载完成后初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeTypingPractice);
        } else {
            // 如果DOM已经加载完成，立即初始化
            setTimeout(initializeTypingPractice, 50);
        }
        
        // 标记为已初始化
        window.ankiTypingInitialized = true;

        // 转换平假名为罗马音
        function convertHiraganaToRomaji(hiragana) {
            
            const hiraganaToRomaji = {
                // 基本假名
                'あ': 'a', 'い': 'i', 'う': 'u', 'え': 'e', 'お': 'o',
                'か': 'ka', 'き': 'ki', 'く': 'ku', 'け': 'ke', 'こ': 'ko',
                'が': 'ga', 'ぎ': 'gi', 'ぐ': 'gu', 'げ': 'ge', 'ご': 'go',
                'さ': 'sa', 'し': 'shi', 'す': 'su', 'せ': 'se', 'そ': 'so',
                'ざ': 'za', 'じ': 'ji', 'ず': 'zu', 'ぜ': 'ze', 'ぞ': 'zo',
                'た': 'ta', 'ち': 'chi', 'つ': 'tsu', 'て': 'te', 'と': 'to',
                'だ': 'da', 'ぢ': 'ji', 'づ': 'zu', 'で': 'de', 'ど': 'do',
                'な': 'na', 'に': 'ni', 'ぬ': 'nu', 'ね': 'ne', 'の': 'no',
                'は': 'ha', 'ひ': 'hi', 'ふ': 'fu', 'へ': 'he', 'ほ': 'ho',
                'ば': 'ba', 'び': 'bi', 'ぶ': 'bu', 'べ': 'be', 'ぼ': 'bo',
                'ぱ': 'pa', 'ぴ': 'pi', 'ぷ': 'pu', 'ぺ': 'pe', 'ぽ': 'po',
                'ま': 'ma', 'み': 'mi', 'む': 'mu', 'め': 'me', 'も': 'mo',
                'や': 'ya', 'ゆ': 'yu', 'よ': 'yo',
                'ら': 'ra', 'り': 'ri', 'る': 'ru', 'れ': 're', 'ろ': 'ro',
                'わ': 'wa', 'ゐ': 'wi', 'ゑ': 'we', 'を': 'wo', 'ん': 'n',
                
                // 拗音
                'きゃ': 'kya', 'きゅ': 'kyu', 'きょ': 'kyo',
                'ぎゃ': 'gya', 'ぎゅ': 'gyu', 'ぎょ': 'gyo',
                'しゃ': 'sha', 'しゅ': 'shu', 'しょ': 'sho',
                'じゃ': 'ja', 'じゅ': 'ju', 'じょ': 'jo',
                'ちゃ': 'cha', 'ちゅ': 'chu', 'ちょ': 'cho',
                'にゃ': 'nya', 'にゅ': 'nyu', 'にょ': 'nyo',
                'ひゃ': 'hya', 'ひゅ': 'hyu', 'ひょ': 'hyo',
                'びゃ': 'bya', 'びゅ': 'byu', 'びょ': 'byo',
                'ぴゃ': 'pya', 'ぴゅ': 'pyu', 'ぴょ': 'pyo',
                'みゃ': 'mya', 'みゅ': 'myu', 'みょ': 'myo',
                'りゃ': 'rya', 'りゅ': 'ryu', 'りょ': 'ryo',
                
                // 特殊记号
                'ー': '-', '・': '・'
            };

            if (!hiragana) return '';
            
            let result = '';
            let i = 0;
            
            while (i < hiragana.length) {
                let converted = false;
                
                // 处理促音 (っ)
                if (hiragana[i] === 'っ' && i + 1 < hiragana.length) {
                    const nextChar = hiragana[i + 1];
                    const nextRomaji = hiraganaToRomaji[nextChar];
                    if (nextRomaji) {
                        result += nextRomaji[0]; // 重复辅音
                        i++;
                        continue;
                    }
                }
                
                // 检查拗音 (2字符)
                if (i + 1 < hiragana.length) {
                    const twoChar = hiragana.slice(i, i + 2);
                    if (hiraganaToRomaji[twoChar]) {
                        result += hiraganaToRomaji[twoChar];
                        i += 2;
                        converted = true;
                    }
                }
                
                // 检查单个字符
                if (!converted) {
                    const oneChar = hiragana[i];
                    if (hiraganaToRomaji[oneChar]) {
                        // 处理特殊的 'n' 规则
                        if (oneChar === 'ん') {
                            // 如果后面是 y, w 或元音，使用 n'
                            if (i + 1 < hiragana.length) {
                                const next = hiragana[i + 1];
                                if ('あいうえおやゆよわをん'.includes(next) || next === 'y' || next === 'w') {
                                    result += "n'";
                                } else {
                                    result += 'n';
                                }
                            } else {
                                result += 'n';
                            }
                        } else {
                            result += hiraganaToRomaji[oneChar];
                        }
                        i++;
                        converted = true;
                    }
                }
                
                // 如果没有转换，保持原字符
                if (!converted) {
                    result += hiragana[i];
                    i++;
                }
            }
            
            // 清理多余的空格和特殊字符
            return result.replace(/\s+/g, '').toLowerCase();
        }
        
    </script>
</body>
</html>